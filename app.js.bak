/**
 * Cinema Archive Vault - åº”ç”¨ç¨‹åºé€»è¾‘ï¼ˆé«˜æ€§èƒ½ç‰ˆï¼‰
 * çº¯ JavaScript å®ç°
 * åŠŸèƒ½ï¼šæ•°æ®å¯è§†åŒ–ã€ç”µå½±åˆ—è¡¨ã€æœç´¢ã€ç­›é€‰ã€æ’åºã€åˆ†é¡µ
 * ä¼˜åŒ–ï¼šå¼‚æ­¥å¤„ç†ã€é˜²æŠ–ã€åˆ†æ‰¹æ¸²æŸ“
 */

// å…¨å±€çŠ¶æ€
let appData = null;
let filteredMovies = [];
let currentYear = null;
let currentPage = 1;
const MOVIES_PER_PAGE = 30;
let searchTimeout = null;
let isProcessing = false;

// åˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', async () => {
  try {
    // åŠ è½½æ•°æ®
    appData = await loadData();
    
    if (!appData) {
      showError('æ— æ³•åŠ è½½æ•°æ®');
      return;
    }

    // åˆå§‹åŒ– UI
    initializeUI();
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬
    setupEventListeners();
    
    // æ˜¾ç¤ºåˆå§‹æ•°æ®
    updateDashboard();
    
    // å¼‚æ­¥æ›´æ–°ç”µå½±åˆ—è¡¨
    updateMoviesListAsync();
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
    showError('åº”ç”¨åˆå§‹åŒ–å¤±è´¥');
  }
});

/**
 * åŠ è½½æ•°æ®
 */
async function loadData() {
  try {
    // æ·»åŠ æ—¶é—´æˆ³å‚æ•°ä»¥æ¸…é™¤ç¼“å­˜
    const timestamp = new Date().getTime();
    const response = await fetch(`processed_movies.json?t=${timestamp}`);
    if (!response.ok) {
      throw new Error('Failed to load data');
    }
    const data = await response.json();
    console.log('æ•°æ®åŠ è½½æˆåŠŸ:', data);
    return data;
  } catch (error) {
    console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
    return null;
  }
}

/**
 * åˆå§‹åŒ– UI
 */
function initializeUI() {
  // æ›´æ–°é¡µå¤´ä¿¡æ¯
  const years = Object.keys(appData.stats_by_year).sort((a, b) => parseInt(b) - parseInt(a));
  document.getElementById('headerDesc').textContent = 
    `æ”¶å½• ${appData.unique_movies.length} éƒ¨ç”µå½±ï¼Œæ¶µç›– ${years.length} ä¸ªæ”¾æ˜ å¹´ä»½`;
  
  // æ›´æ–°é¡µè„šä¿¡æ¯
  document.getElementById('footerInfo').textContent = 
    `æ•°æ®: ${appData.unique_movies.length} éƒ¨ç”µå½± | ${years.length} ä¸ªæ”¾æ˜ å¹´ä»½`;

  // è®¾ç½®åˆå§‹å¹´ä»½ï¼ˆå¿…é¡»åœ¨ç”Ÿæˆé€‰æ‹©å™¨ä¹‹å‰ï¼‰
  currentYear = years[0];

  // ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨
  generateYearSelector(years);
  
  // ç”Ÿæˆç”µå½±å¹´ä»½ç­›é€‰é€‰é¡¹
  generateYearFilterOptions();
  
  // ç”Ÿæˆç”µå½±ç±»å‹ç­›é€‰é€‰é¡¹
  generateGenreFilterOptions();
}

/**
 * ç”Ÿæˆå¹´ä»½é€‰æ‹©å™¨æŒ‰é’®
 */
function generateYearSelector(years) {
  const selector = document.getElementById('yearSelector');
  selector.innerHTML = '';
  
  years.forEach(year => {
    const btn = document.createElement('button');
    btn.className = `year-btn ${String(year) === String(currentYear) ? 'active' : ''}`;
    btn.textContent = `${year}å¹´`;
    btn.dataset.year = year;
    btn.addEventListener('click', () => selectYear(year));
    selector.appendChild(btn);
  });
}

/**
 * é€‰æ‹©å¹´ä»½
 */
function selectYear(year) {
  currentYear = year;
  
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  document.querySelectorAll('.year-btn').forEach(btn => {
    btn.classList.toggle('active', String(btn.dataset.year) === String(year));
  });
  
  // æ›´æ–°ä»ªè¡¨æ¿
  updateDashboard();
}

/**
 * ç”Ÿæˆç”µå½±å¹´ä»½ç­›é€‰é€‰é¡¹
 */
function generateYearFilterOptions() {
  const select = document.getElementById('yearFilter');
  const years = new Set();
  
  appData.unique_movies.forEach(movie => {
    if (movie.movie_year) {
      years.add(movie.movie_year);
    }
  });
  
  const sortedYears = Array.from(years).sort((a, b) => parseInt(b) - parseInt(a));
  
  sortedYears.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    select.appendChild(option);
  });
}

/**
 * ç”Ÿæˆç”µå½±ç±»å‹ç­›é€‰é€‰é¡¹
 */
function generateGenreFilterOptions() {
  const select = document.getElementById('genreFilter');
  
  appData.global_stats.all_genres.forEach(genre => {
    const option = document.createElement('option');
    option.value = genre;
    option.textContent = genre;
    select.appendChild(option);
  });
}

/**
 * è®¾ç½®äº‹ä»¶ç›‘å¬
 */
function setupEventListeners() {
  // æ ‡ç­¾é¡µåˆ‡æ¢
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabName = btn.dataset.tab;
      switchTab(tabName);
    });
  });

  // æœç´¢ï¼ˆä½¿ç”¨é˜²æŠ–ï¼‰
  document.getElementById('searchInput').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      currentPage = 1;
      updateMoviesListAsync();
    }, 300);
  });
  
  // ç­›é€‰
  document.getElementById('yearFilter').addEventListener('change', () => {
    currentPage = 1;
    updateMoviesListAsync();
  });
  document.getElementById('genreFilter').addEventListener('change', () => {
    currentPage = 1;
    updateMoviesListAsync();
  });
  document.getElementById('sortFilter').addEventListener('change', () => {
    currentPage = 1;
    updateMoviesListAsync();
  });
}

/**
 * åˆ‡æ¢æ ‡ç­¾é¡µ
 */
function switchTab(tabName) {
  // éšè—æ‰€æœ‰é¢æ¿
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.remove('active');
  });
  
  // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„æ´»è·ƒçŠ¶æ€
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
  document.getElementById(tabName).classList.add('active');
  
  // æ¿€æ´»é€‰ä¸­çš„æŒ‰é’®
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
}

/**
 * æ›´æ–°ä»ªè¡¨æ¿
 */
function updateDashboard() {
  if (!currentYear || !appData.stats_by_year[currentYear]) {
    return;
  }

  const yearStats = appData.stats_by_year[currentYear];
  
  // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
  document.getElementById('statMovies').textContent = yearStats.total;
  document.getElementById('statCountries').textContent = yearStats.top_countries.length;
  document.getElementById('statGenres').textContent = yearStats.top_genres.length;
  
  // æ›´æ–°å›¾è¡¨
  renderChart('genreChart', yearStats.top_genres);
  renderChart('countryChart', yearStats.top_countries);
  renderChart('directorChart', yearStats.top_directors);
}

/**
 * æ¸²æŸ“å›¾è¡¨ï¼ˆæ”¯æŒå¤šç§ç±»å‹å’Œé¢œè‰²ï¼‰
 */
function renderChart(containerId, data, chartType = 'bar') {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  if (!data || data.length === 0) {
    container.innerHTML = '<p style="color: var(--color-text-muted);">æš‚æ— æ•°æ®</p>';
    return;
  }

  // é™åˆ¶æ˜¾ç¤ºæ•°é‡
  const displayData = data.slice(0, 10);
  const maxValue = Math.max(...displayData.map(item => item.count));
  
  // æ ¹æ®å›¾è¡¨ç±»å‹é€‰æ‹©ä¸åŒçš„é¢œè‰²
  const colors = [
    'linear-gradient(90deg, #6366f1 0%, #818cf8 100%)',
    'linear-gradient(90deg, #ec4899 0%, #f472b6 100%)',
    'linear-gradient(90deg, #14b8a6 0%, #2dd4bf 100%)',
    'linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%)',
    'linear-gradient(90deg, #10b981 0%, #34d399 100%)',
    'linear-gradient(90deg, #8b5cf6 0%, #a78bfa 100%)',
    'linear-gradient(90deg, #ef4444 0%, #f87171 100%)',
    'linear-gradient(90deg, #06b6d4 0%, #22d3ee 100%)',
    'linear-gradient(90deg, #d946ef 0%, #e879f9 100%)',
    'linear-gradient(90deg, #fbbf24 0%, #fcd34d 100%)',
  ];
  
  displayData.forEach((item, index) => {
    const percentage = (item.count / maxValue) * 100;
    const color = colors[index % colors.length];
    
    const itemEl = document.createElement('div');
    itemEl.className = 'chart-item';
    itemEl.innerHTML = `
      <div class="chart-label" title="${item.name}">${item.name}</div>
      <div class="chart-bar-container">
        <div class="chart-bar" style="background: ${color}; width: ${percentage}%"></div>
      </div>
      <div class="chart-value">${item.count}</div>
    `;
    
    container.appendChild(itemEl);
  });
}

/**
 * å¼‚æ­¥æ›´æ–°ç”µå½±åˆ—è¡¨
 */
function updateMoviesListAsync() {
  if (isProcessing) return;
  isProcessing = true;
  
  // è·å–ç­›é€‰æ¡ä»¶
  const searchText = document.getElementById('searchInput').value.toLowerCase();
  const yearFilter = document.getElementById('yearFilter').value;
  const genreFilter = document.getElementById('genreFilter').value;
  const sortBy = document.getElementById('sortFilter').value;

  // ä½¿ç”¨ setTimeout è®©å‡ºä¸»çº¿ç¨‹
  setTimeout(() => {
    try {
      // è¿‡æ»¤ç”µå½±
      filteredMovies = appData.unique_movies.filter(movie => {
        // æœç´¢è¿‡æ»¤
        if (searchText) {
          const matchesSearch = 
            movie.title.toLowerCase().includes(searchText) ||
            (movie.director && movie.director.toLowerCase().includes(searchText)) ||
            (movie.actors && movie.actors.toLowerCase().includes(searchText));
          
          if (!matchesSearch) return false;
        }

        // å¹´ä»½è¿‡æ»¤
        if (yearFilter && movie.movie_year !== yearFilter) {
          return false;
        }

        // ç±»å‹è¿‡æ»¤
        if (genreFilter && !movie.genres_list.includes(genreFilter)) {
          return false;
        }

        return true;
      });

      // æ’åº
      filteredMovies = sortMovies(filteredMovies, sortBy);

      // æ¸²æŸ“åˆ—è¡¨
      renderMoviesList();
    } finally {
      isProcessing = false;
    }
  }, 0);
}

/**
 * æ’åºç”µå½±
 */
function sortMovies(movies, sortBy) {
  const sorted = [...movies];
  
  switch (sortBy) {
    case 'rating-desc':
      sorted.sort((a, b) => {
        const ratingA = parseFloat(a.rating === 'æš‚æ— è¯„åˆ†' ? '0' : a.rating);
        const ratingB = parseFloat(b.rating === 'æš‚æ— è¯„åˆ†' ? '0' : b.rating);
        return ratingB - ratingA;
      });
      break;
    case 'rating-asc':
      sorted.sort((a, b) => {
        const ratingA = parseFloat(a.rating === 'æš‚æ— è¯„åˆ†' ? '0' : a.rating);
        const ratingB = parseFloat(b.rating === 'æš‚æ— è¯„åˆ†' ? '0' : b.rating);
        return ratingA - ratingB;
      });
      break;
    case 'title':
      sorted.sort((a, b) => a.title.localeCompare(b.title));
      break;
    case 'year-desc':
      sorted.sort((a, b) => parseInt(b.movie_year || '0') - parseInt(a.movie_year || '0'));
      break;
    case 'year-asc':
      sorted.sort((a, b) => parseInt(a.movie_year || '0') - parseInt(b.movie_year || '0'));
      break;
  }
  
  return sorted;
}

/**
 * æ¸²æŸ“ç”µå½±åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
 */
function renderMoviesList() {
  const grid = document.getElementById('moviesGrid');
  const info = document.getElementById('moviesInfo');
  
  // è®¡ç®—åˆ†é¡µ
  const totalPages = Math.ceil(filteredMovies.length / MOVIES_PER_PAGE);
  const startIdx = (currentPage - 1) * MOVIES_PER_PAGE;
  const endIdx = startIdx + MOVIES_PER_PAGE;
  const pageMovies = filteredMovies.slice(startIdx, endIdx);
  
  // æ›´æ–°ä¿¡æ¯æ–‡æœ¬
  info.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span>æ‰¾åˆ° ${filteredMovies.length} éƒ¨ç”µå½±ï¼Œç¬¬ ${currentPage}/${totalPages} é¡µ</span>
      <div id="pagination" class="pagination"></div>
    </div>
  `;
  
  // æ¸…ç©ºç½‘æ ¼
  grid.innerHTML = '';
  
  if (filteredMovies.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç”µå½±</div>';
    return;
  }

  // æ¸²æŸ“ç”µå½±å¡ç‰‡
  pageMovies.forEach(movie => {
    const card = createMovieCard(movie);
    grid.appendChild(card);
  });
  
  // æ¸²æŸ“åˆ†é¡µæ§ä»¶
  renderPagination(totalPages);
}

/**
 * æ¸²æŸ“åˆ†é¡µæ§ä»¶
 */
function renderPagination(totalPages) {
  const paginationContainer = document.getElementById('pagination');
  paginationContainer.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  // ä¸Šä¸€é¡µæŒ‰é’®
  if (currentPage > 1) {
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.textContent = 'â† ä¸Šä¸€é¡µ';
    prevBtn.addEventListener('click', () => {
      currentPage--;
      renderMoviesList();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(prevBtn);
  }
  
  // é¡µç æŒ‰é’®
  const maxPagesToShow = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
  let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
  
  if (endPage - startPage < maxPagesToShow - 1) {
    startPage = Math.max(1, endPage - maxPagesToShow + 1);
  }
  
  if (startPage > 1) {
    const firstBtn = document.createElement('button');
    firstBtn.className = 'pagination-btn';
    firstBtn.textContent = '1';
    firstBtn.addEventListener('click', () => {
      currentPage = 1;
      renderMoviesList();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(firstBtn);
    
    if (startPage > 2) {
      const dots = document.createElement('span');
      dots.className = 'pagination-dots';
      dots.textContent = '...';
      paginationContainer.appendChild(dots);
    }
  }
  
  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
    btn.textContent = i;
    btn.addEventListener('click', () => {
      currentPage = i;
      renderMoviesList();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(btn);
  }
  
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const dots = document.createElement('span');
      dots.className = 'pagination-dots';
      dots.textContent = '...';
      paginationContainer.appendChild(dots);
    }
    
    const lastBtn = document.createElement('button');
    lastBtn.className = 'pagination-btn';
    lastBtn.textContent = totalPages;
    lastBtn.addEventListener('click', () => {
      currentPage = totalPages;
      renderMoviesList();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(lastBtn);
  }
  
  // ä¸‹ä¸€é¡µæŒ‰é’®
  if (currentPage < totalPages) {
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.textContent = 'ä¸‹ä¸€é¡µ â†’';
    nextBtn.addEventListener('click', () => {
      currentPage++;
      renderMoviesList();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(nextBtn);
  }
}

/**
 * åˆ›å»ºç”µå½±å¡ç‰‡
 */
function createMovieCard(movie) {
  const card = document.createElement('div');
  card.className = 'movie-card';
  
  // ä»è±†ç“£ URL ä¸­æå–ç”µå½± ID
  const movieIdMatch = movie.url.match(/\/subject\/(\d+)\//);
  const movieId = movieIdMatch ? movieIdMatch[1] : null;
  const posterPath = movieId ? `images/posters/${movieId}.webp` : null;
  
  // ç”Ÿæˆæ˜Ÿçº§
  const rating = parseFloat(movie.rating === 'æš‚æ— è¯„åˆ†' ? '0' : movie.rating);
  const stars = Math.round(rating / 2);
  let starsHtml = '';
  for (let i = 0; i < 5; i++) {
    starsHtml += `<span class="star ${i < stars ? '' : 'empty'}">â˜…</span>`;
  }
  
  card.innerHTML = `
    <div class="movie-poster">
      ${posterPath ? `<img src="${posterPath}" alt="${movie.title}" loading="lazy">` : ''}
      <div class="movie-poster-placeholder" ${posterPath ? 'style="display: none;"' : ''}>
        æ— æµ·æŠ¥
      </div>
      <div class="movie-overlay">
        <a href="${movie.url}" target="_blank" rel="noopener noreferrer" title="åœ¨è±†ç“£æŸ¥çœ‹">ğŸ”—</a>
      </div>
    </div>
    <div class="movie-info">
      <h3 class="movie-title">${movie.title}</h3>
      <div class="movie-rating">
        <div class="movie-stars">${starsHtml}</div>
        <span class="movie-score">${movie.rating}</span>
      </div>
      <div class="movie-meta">
        <strong>${movie.country}</strong> Â· ${movie.movie_year}
      </div>
      <div class="movie-tags">
        ${movie.genres_list.map(genre => `<span class="movie-tag">${genre}</span>`).join('')}
      </div>
    </div>
  `;
  
  return card;
}

/**
 * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
 */
function showError(message) {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: var(--color-error); font-size: 1.2rem;">
      ${message}
    </div>
  `;
}
